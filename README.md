# Changelog

## Версия 1.0 → 2.0 (2025-01-03)

### 1. Сессионная логика (session)
- Добавлена концепция «сессии» (длительностью `SESSION_DURATION` секунд), внутри которой:
  - **Видео** копятся в список и по окончании сессии **отправляются одним сообщением** (медиагруппой).
  - **Кадры (`-capture.jpg`)** также удаляются по завершении сессии.

### 2. Единичный кадр (65-й) на сессию
- **Теперь** при появлении первого `65`‑го кадра скрипт:
  - Запускает новую «сессию».
  - Отправляет **единственный** кадр (после появления `66`‑го).
  - Все повторные `65`‑е кадры, которые возникают в течение активной сессии, **игнорируются** (чтобы не заспамливать чат).

### 3. Отправка видео одним «альбомом»
- По истечении `SESSION_DURATION` (например, 120 секунд) вызывается `end_session()`, которая:
  - Отправляет все накопленные `*-video.mp4` **одним** вызовом [`sendMediaGroup`](https://core.telegram.org/bots/api#sendmediagroup).
  - После успешной отправки **удаляет** видеофайлы локально.

### 4. Увеличенное время ожидания завершения записи видео
- **Логика стабильности** (`wait_for_file_stable`):
  - Увеличили число проверок (`CHECK_STABLE_MAX_ATTEMPTS`) и/или добавили «жёсткую» паузу перед проверкой.
  - Это нужно, чтобы ZoneMinder успел дописать 30+‑секундные ролики (иначе раньше получали «файл всё ещё растёт» и пропускали видео).

### 5. Очистка кадров (delete_all_captures_in_folder)
- По завершении сессии (`end_session()`) вызывается удаление **всех** кадров `*-capture.jpg` в папках, которые фигурировали в данной сессии.
- Если хотите сразу удалить `00065-capture.jpg` после отправки, это можно раскомментировать в `_send_frame_65`, но в основном всё чистится в конце сессии.

### 6. Дополнительная защита от дубликатов 65‑го кадра
- В метод `_send_frame_65` добавлен **дополнительный** проверочный блок:
  - Если `current_session["sent_first_frame"] == True`, то кадр не отправляем повторно.
  - Это решает проблему, когда Watchdog мог по разным причинам вызвать `_send_frame_65` повторно для одного и того же события.

---

**Итог:**  
Вместо множества отдельных уведомлений (каждый с 65‑м кадром и видео) при движении за **одну** сессию вы получаете:
1. **Одно** мгновенное уведомление (65‑й кадр).
2. **Одно** уведомление с «альбомом» видео по завершении (истечении `SESSION_DURATION`).
3. После отправки автоматически удаляются временные файлы (кадры и видео).

Такой подход уменьшает спам в чате и делает логику более удобной для обзора событий в ZoneMinder.
